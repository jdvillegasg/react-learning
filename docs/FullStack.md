# Backend

## Bun 

Create a Bun project with `bun init`. 

# Client Side Rendered Single Page App with Vite

## Development

There are two different servers used: one for the frontend (i.e. vite) and another one for the backend (i.e. bun)

## Production

To host the frontend and the backend in the same place, an easy way to do it is by *placing the frontend files inside the backend (API) server*.

## Apporach in development

To mimic the behavior of using just one server for both frontend and backend, it is possible to *proxy request from the frontend to the backend*.

For example, if the backend is at `localhost:3000/api` and the frontend is at `localhost:5173`:

* We can first handle requests to frontend endpoints, i.e. `localhost:5173/api`

* And then forward the frontend request to our backend endpoint, i.e. `localhost:3000/api`.

As a consequence of this approach, our frontend fetches will request to `/api` instead of requesting to `https://localhost:3000/api`.

To forward the frontend request to the backend, we create a proxy server in the `vite.config.js` file, by adding the following:

!!! example "Forward requests to backend server in development"
    ```js
    //...
    server: {
        proxy: {
            "/api": {
                target: "http://localhost:3000",
                changeOrigin: true,
            },
        },
    },
    //...
    ```

## Approach in production

We need to have a plan for building and serving the frontend app from the backend server app (i.e. Hono).

**First** we build the frontend application:

```sh
bun run build
```

This will create a `dist/assets` folder with the transpiled and minimezd files required to run the application. All the frontend can be served by using the `dist` folder.

**Then**, we extend the backend server (i.e. Hono bun) to serve the frontend whenever the user requests an API route that doesn't match any of the ones existing in the backend server:

```jsx
app = new Hono()
app.get("/my-backend-endpoint", myHonoRoute)
//...
// Serve the frontend if API route different to all existing routes
app.get("*", serveStatic({ root: "./frontend/dist" }));
app.get("*", serveStatic({ path: "./frontend/dist/index.html" }));
// ...
```

In the above example, the static files generated by building the frontend app are stored in the `dist` directory of our `frontend` directory.

To check if it works, you can search the url of the backend (i.e. `localhost:3000`) and it should show the frontend app.


# Deployment

## Fly.io

!!! failure
    Requires credit card on May/2024

* Register on [Fly.io](https://fly.io)

* Install `flyctl` by running on the PowerShell:

```sh
    pwsh -Command "iwr https://fly.io/install.ps1 -useb | iex"
```

or

```sh
    powershell -Command "iwr https://fly.io/install.ps1 -useb | iex"
```

* Run `fly launch` from the directory containing your frontend and backend folders.

This will produce a `Dockerfile` and a `fly.toml` file.

* Run `fly deploy` 

* Each time changes in the frontend are done, we need to run `bun run build` in the frontend folder, to produce the updated `dist/` folder. 

After doing so, we need to deploy the backend (that in this approach will serve the the frontend). In this case, as mentioned before, we do that by running `fly deploy`.

These two steps can be merged by modifying the `Dockerfile`:

```sh
# Install frontend node modules
COPY --link frontend/bun.lockb frontend/package.json ./frontend/
RUN cd frontend && bun install --ci

# Copy application code
COPY --link . .

# Change to frontend directory and build the frontend app
WORKDIR /app/frontend
RUN bun run build

# Remove all files in frontend except for the dist folder
RUN find . -mindepth 1 ! -regex '^./dist\(/.*\)?' -delete
```